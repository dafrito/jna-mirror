<html>
<head>
<meta name="author" content="Timothy Wall">
<meta name="keywords" content="java,jna,jni,c/c++,native,method,function,call,ctypes,ffi,foreign function interface,jdirect,jinvoke,pinvoke,platform invoke,native library access,native access,call native from java,java c library,easy jni,call c code from java,avoid jni">
<meta name="description" content="Java Native Access (JNA): access native libraries with pure Java code.">
<meta name="date" content="2007-09-10">
<title>Java Native Access (JNA): Pure Java access to native libraries</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
</head>
<body>
<h2>Java Native Access (JNA) </h2>
<p>JNA provides Java programs easy access to native shared libraries (DLLs on Windows) without writing anything but Java code&#8212;no JNI or native code is required.  This functionality is comparable to Windows' Platform/Invoke and Python's ctypes.  Access is dynamic at runtime without code generation.</p>
<p>JNA's design aims to provide native access in a natural way with a minimum of effort.  No boilerplate or generated code is required.  While some attention is paid to performance, correctness and ease of use take priority.</p>
<p>The JNA library uses a small native library stub to dynamically invoke native code. The developer uses a Java interface to describe functions and structures in the target native library.  This makes it quite easy to take advantage of native platform features without incurring the high overhead of configuring and building JNI code (overhead would otherwise increase with each supported platform). </p>
The <a href="javadoc/overview-summary.html">JavaDoc is available online</a>,
which includes an overview of specific usage.<p>
<b>NOTE: Sun is <em>not</em> sponsoring this project, even though the package name (<code>com.sun.jna</code>) might imply otherwise.</b>

 <h3>Features</h3>
<ul>
<li>Most platforms supported
<li>Automatic mapping from Java interface to native function
<li>8-, 16-, 32, and 64-bit basic data types
<li>Structure and Union pointer arguments
<li>Automatic conversion between C and Java strings
<li>Function pointers (callbacks from native code to Java code) as arguments and/or members of a <code>struct</code>
<li>By-reference (pointer-to-type) arguments 
<li>Java array and Buffer arguments (primitive types and pointers) as pointer-to-buffer
<li>Nested structures and arrays
<li><code>wchar_t</code>-based strings
<li>Native <code>long</code> support (32- or 64-bit as appropriate)
<li><a href="#demos">Full-blown demo applications</a>
<li>Supported on 1.4 or later JVMs (earlier can work without NIO support)
<li>Customizable argument and return value conversions
<li>Customizable mapping from Java method to native function name
<li>Support for automatic w32 ASCII/UNICODE mappings
<li>Auto-generated proxies for native function pointers in structs
<li>Varargs support
<li>Optional <a href="javadoc/com/sun/jna/PointerType.html">type-safety for native pointers</a>
<li>Optional <a href="javadoc/com/sun/jna/Native.html#setProtected(boolean)">VM crash protection</a>
</ul>

 <h3>How To Get Started Using JNA</h3>
 <p>Java Native Access (JNA) has a single component, <code>jna.jar</code>; the supporting native library (<code>jnidispatch</code>) is included in the jar file. JNA is capable of extracting and loading the native library on its own, so you don't need additional configuration.  The native library is also available in platform-specific jar files for use with Java Web Start.</p>
<ol>
  <li>Download <code>jna.jar</code> from the <a href="https://jna.dev.java.net/servlets/ProjectDocumentList?folderID=7408&expandFolder=7408&folderID=0">download page</a>.</li>
  <li>Identify a native <em>target library</em> that you want to use. This can be any shared library with exported functions.  A good example is the local C library (libc.so on linux or msvcrt.dll on windows).</li>
  <li>Make your target library available to your Java program. There are two ways to do this:
    <ul>
      <li>The preferred method is to set the <code>jna.library.path</code> system property to the path to your target library.  This property is similar to <code>java.library.path</code> but only applies to libraries loaded by JNA.</li> 
      <li>Change the appropriate library access environment variable.  This is PATH on Windows, LD_LIBRARY_PATH on Linux, and DYLD_LIBRARY_PATH on OSX.</li>
    </ul>
  </li>
  <li>Declare a Java interface to hold the native library methods by extending the <a href="javadoc/com/sun/jna/Library.html"><code>Library</code></a> interface.  Following is an example of mapping for the Windows kernel32 library.<br>
    <textarea name="textarea" cols="80" rows="8" readonly="readonly">
package com.sun.jna.examples.win32;

import com.sun.jna.*;

// kernel32.dll uses the __stdcall calling convention
// Most C libraries will just extend com.sun.jna.Library
public interface Kernel32 extends StdCallLibrary { 
    // Method declarations, constant and structure definitions go here
}</textarea>
  </li>
  <li>In your interface, allocate an instance of the native library using the <code>Native.loadLibrary(Class)</code> method, providing the native library interface you defined in step (4).<br>    
    <textarea name="textarea" cols="80" rows="2" readonly="readonly">
    Kernel32 INSTANCE = (Kernel32)
        Native.loadLibrary("kernel32", Kernel32.class);
</textarea><br>
This instance is for convenient reuse.  Alternatively, you can load the library into a local variable so that it will be available for garbage collection when it goes out of scope.
  </li>
  <li>Declare methods that mirror the functions in the target library by defining Java methods with the same name and argument types as the native function (refer to <a href="javadoc/overview-summary.html#marshalling">this table of type mappings</a>).  You may also need to declare native structures to pass to your native functions. To do this, create a class that extends <a href="javadoc/com/sun/jna/Structure.html"><code>Structure</code></a> and add public fields (which may include arrays or nested structures).</li>
    <textarea name="textarea" cols="80" rows="12" readonly="readonly">
    public static class SYSTEMTIME extends Structure {
        public short wYear;
        public short wMonth;
        public short wDayOfWeek;
        public short wDay;
        public short wHour;
        public short wMinute;
        public short wSecond;
        public short wMilliseconds;
    }

    void GetSystemTime(SYSTEMTIME result);
</textarea>
  </li>
  <li>You can now invoke methods on the library instance just like any other Java class.  For a more extensive example, see the <a href="https://jna.dev.java.net/source/browse/jna/trunk/jnalib/src/com/sun/jna/examples/WindowUtils.java?rev=HEAD&view=markup">WindowUtils</a> and <a href="https://jna.dev.java.net/source/browse/jna/trunk/jnalib/src/com/sun/jna/examples/ShapedWindowDemo.java?rev=HEAD&view=markup">ShapedWindowDemo</a> classes.
    <br>    
    <textarea name="textarea4" cols="80" rows="4" readonly="readonly">
Kernel32 lib = Kernel32.INSTANCE;
SYSTEMTIME time = new SYSTEMTIME();
lib.GetSystemTime(time);
System.out.println("Today's integer value is " + time.wDay);
</textarea>
  </li>
</ol>
See the <a href="javadoc/overview-summary.html#overview">JavaDoc overview</a> for additional details.<p>
<h3>Pointers and Arrays</h3>
Primitive array arguments (including <code>struct</code>s) are represented by their corresponding Java types.  For example:
<blockquote>
    <textArea name="textarea" cols="80" rows="6" readonly="readonly">
// C declarations
void fill_buffer(int *buf, int len);
void fill_buffer(int buf[], int len); // same thing with array syntax

// Java interface method
void fill_buffer(int[] buf, int len);
</textarea>
</blockquote>

When passing in an array of <code>Structure</code>, it is not necessary to initialize the array, unless the function is using the data as input.  If you <em>do</em> need to initialize the array, you should use the <code>Structure.toArray</code> method to obtain an array of elements contiguous in memory.
<p>
Arrays of C strings (the <code>char* argv[]</code> to the C <code>main</code>, for example), may be represented by <code>String[]</code> in Java code.

<h3>By-reference Arguments</h3>
When a function accepts a pointer-to-type argument you can use one of the <a href="javadoc/com/sun/jna/ptr/ByReference.html"><code>ByReference</code></a> types to capture the returned value, or subclass your own.  For example:<br>
<blockquote>
    <textarea name="textarea4" cols="80" rows="12" readonly="readonly">
// C declaration
void allocate_buffer(char **bufp, int* lenp);

// Java interface method
void allocate_buffer(PointerByReference bufp, IntByReference lenp);

// Usage
PointerByReference pref = new PointerByReference();
IntByReference iref = new IntByReference();
lib.allocate_buffer(pref, iref);
Pointer p = pref.getValue();
byte[] buffer = p.getByteArray(0, iref.getValue());
    </textarea>
</blockquote>

Alternatively, you could use a Java array with a single element of the desired type, but the <code>ByReference</code> convention better conveys the intent of the code.<p>

The <a href="javadoc/com/sun/jna/Pointer.html"><code>Pointer</code></a> class provides a number of accessor methods in addition to <a href="javadoc/com/sun/jna/Pointer.html#getByteArray"><code>getByteArray()</code></a> which effectively function as a typecast onto the memory.
<p>
Type-safe pointers may be declared by deriving from the <a href="javadoc/com/sun/jna/PointerType.html"><code>PointerType</code></a> class.

<h3>Customized Mapping from Java to Native (Types and Function Names)</h3>
The <a href="javadoc/com/sun/jna/TypeMapper.html">TypeMapper</a> class and related interfaces provide for converting any Java type used as an argument, return value, or structure member to be converted to or from a native type.  The example w32 API interfaces use a type mapper to convert Java boolean into the w32 <code>BOOL</code> type.
<p>
Alternatively, user-defined types may implement the <a href="javadoc/com/sun/jna/win32/NativeMapped.html">NativeMapped</a> interface, which determines conversion to and from native types on a class-by-class basis.
<p>
You may also customize the mapping of Java method names to the corresponding native function name.  The <a href="javadoc/com/sun/jna/win32/StdCallFunctionMapper.html">StdCallFunctionMapper</a> is one implementation which automatically generates <code>stdcall</code>-decorated function names from a Java interface method signature.
<p>
Refer to <a href="javadoc/overview-summary.html#marshalling">this table in the
overview</a> for a complete list of built-in type mappings.
<p>
<h3>Callbacks (Function Pointers)</h3>
Callback declarations consist of a simple interface that extends the <a href="javadoc/com/sun/jna/Callback.html">Callback</a>
interface and implements a <code>callback</code> method.  Callbacks are
implemented by wrapping a Java object method in a little bit of C glue code.
The simplest usage resembles using anonymous inner classes to register event
listeners.  Following is an example of callback usage:<br> 
<blockquote>
    <textarea name="textarea4" cols="80" rows="10" readonly="readonly">
// C declarations
typedef void (*FUNCTION)();
int atexit(FUNCTION);

// Java mappings
public interface CLibrary extends Library {
    interface FUNCTION extends Callback {
        void callback();        
    }
    int atexit(FUNCTION fn);
}
...
CLibrary lib = CLibrary.INSTANCE;
lib.atexit(new FUNCTION() {
    public void callback() {
        System.out.println("exit was called");  
    }
});
</textarea>
</blockquote>

Here is a more complex example, using the w32 APIs to enumerate all native windows:
<blockquote>
    <textarea name="textarea4" cols="80" rows="17" readonly="readonly">
// C declarations
typedef int (__stdcall *WNDENUMPROC)(void*,void*);
int __stdcall EnumWindows(WNDENUMPROC,void*);

// Java mappings
public interface User32 extends StdCallLibrary {
    interface WNDENUMPROC extends StdCallCallback {
        /** Return whether to continue enumeration. */
        boolean callback(Pointer hWnd, Pointer arg);
    }
    boolean EnumWindows(WNDENUMPROC lpEnumFunc, Pointer arg);
}
...
User32 user32 = User32.INSTANCE;

user32.EnumWindows(new WNDENUMPROC() {
    int count;
    public boolean callback(Pointer hWnd, Pointer userData) {
        System.out.println("Found window " + hWnd + ", total " + ++count);
        return true;
    }
}, null);
</textarea>
</blockquote>
If your callback needs to live beyond the method invocation where it is used, make sure you keep a reference to it or the native code will call back to an empty stub after the callback object is garbage collected.<p>

Proxy wrappers are automatically generated for function pointers found within structs initialized by native code.  This facilitates calling those functions from Java.<p>

<h3>Invocation from Dynamically-Typed Languages</h3>
Languages such as <a href=http://www.jython.org>Jython</a> or <a href=http://jruby.sf.net>JRuby</a> may find it more convenient to access the NativeLibrary and Function classes directly rather than establishing a dedicated interface.<p>
Here's a brief example of using JNA from JRuby:
<blockquote>
    <textarea name="textarea4" cols="80" rows="16" readonly="readonly">
require 'java'

module Libc
  @@lib = com.sun.jna.NativeLibrary.getInstance("c")
  @@ptr_funcs = [ 'fopen', 'malloc', 'calloc' ]
  def self.method_missing(meth, *args)
    if @@ptr_funcs.include?(meth.to_s)
      @@lib.getFunction(meth.to_s).invokePointer(args.to_java)
    else
      @@lib.getFunction(meth.to_s).invokeInt(args.to_java)
    end
  end
  O_RDONLY = 0
  O_WRONLY = 1
  O_RDWR = 2
end

Libc.puts("puts from libc")
Libc.printf("Hello %s, from printf\n", "World")

file = Libc.open("/dev/stdout", 1, Libc::O_WRONLY)
n = Libc.write(file, "Test\n", 5)
puts "Wrote #{n} bytes via Libc"

path = "/dev/stdout"
fp = Libc.fopen(path, "w+")
Libc.fprintf(fp, "fprintf to %s via stdio\n", path)
Libc.fflush(fp)
Libc.fclose(fp)
</textarea></blockquote>

<a name=demos></a>
<h3>Examples</h3>
In the <code>com.sun.jna.examples</code> package are some examples of using
the JNA library (and are pretty nifty utilities in and of themselves).
<ul>
<li><a href="https://jna.dev.java.net/source/browse/jna/trunk/jnalib/src/com/sun/jna/examples/ShapedWindowDemo.java?rev=HEAD&view=markup">ShapedWindowDemo</a>: Non-rectangular windows (a circular clock) (<a href="https://jna.dev.java.net/source/browse/jna/trunk/jnalib/src/com/sun/jna/examples/WindowUtils.java?rev=HEAD&view=markup">WindowUtils code</a>).<p>
<a href="demo/ShapedWindowDemo.jnlp"><img src="http://swinglabs.org/images/demobutton.png" /></a>
<li><a href="https://jna.dev.java.net/source/browse/jna/trunk/jnalib/src/com/sun/jna/examples/BalloonManagerDemo.java?rev=HEAD&view=markup">BalloonManagerDemo</a>: Speech-balloon windows (a la Google Maps) (<a href="https://jna.dev.java.net/source/browse/jna/trunk/jnalib/src/com/sun/jna/examples/BalloonManager.java?rev=HEAD&view=markup">BalloonManager code</a>).<p>
<a href="demo/BalloonManagerDemo.jnlp"><img src="http://swinglabs.org/images/demobutton.png" /></a>
<li><a href="https://jna.dev.java.net/source/browse/jna/trunk/jnalib/src/com/sun/jna/examples/FileUtils.java?rev=HEAD&view=markup">FileUtils</a>: Cross-platform move-to-trash functionality
<li><a href="https://jna.dev.java.net/source/browse/jna/trunk/jnalib/src/com/sun/jna/examples/FileMonitor.java?rev=HEAD&view=markup">FileMonitor</a>: Cross-platform file change notification (still needs inotify and kqueues implementations)
</ul>

 <h3>Community</h3>
 <p>Please use the appropriate <a href="https://jna.dev.java.net/servlets/ProjectMailingListList">mailing list</a> to ask for help, suggest ideas, contribute patches, etc.  All contributions are welcome.</p>
 <p>All mailing lists are also available via RSS:
 <ul>
 <li><a href="https://jna.dev.java.net/servlets/MailingListRSS?listName=announce"><img src=https://jna.dev.java.net/branding/images/rss.gif></img> Announcements</a>
 <li><a href="https://jna.dev.java.net/servlets/MailingListRSS?listName=users"><img src=https://jna.dev.java.net/branding/images/rss.gif></img> Usage Questions and Discussion</a>
 <li><a href="https://jna.dev.java.net/servlets/MailingListRSS?listName=dev"><img src=https://jna.dev.java.net/branding/images/rss.gif></img> Development Discussion</a>
 <li><a href="https://jna.dev.java.net/servlets/MailingListRSS?listName=issues"><img src=https://jna.dev.java.net/branding/images/rss.gif></img> Bugs and Enhancements Issue Tracking</a>
 </ul>
 <h3>Development Tasks</h3>
 <p>The library works fairly well now, but there are a number of tasks with which we'd appreciate help:</p>
 <ul>
   <li>More comprehensive documentation on using JNA, including examples of Java to native conversions of data types, function usage, and proper memory management.</li>
   <li>Native library definitions for the more useful libraries on various platforms; for example, <code>user32</code> on Windows.  This is important not for having an exhaustive library definition but to illustrate all the different ways a native library may need to be mapped.</li>
   <li>Peer review the design and suggest improvements and enhancements</li>
   <li>Build the <code>jnidispatch</code> library backend on new platforms (it should mostly work out of the box if we can just get access to the appropriate build platform).</li>
   <li>Testing on various JDK versions and platforms (linux flavors!).</li>
   <li>Tips and recommended usage of JNA: Likely danger areas, failure modes, best practices, multithreading, etc.</li>
 </ul>
<h3>Building and Multi-platform support</h3>
JNA has been built and tested on OSX (PPC and x86), linux (x86, amd64),
FreeBSD, SunOS (x86, sparc, sparcv9) and Windows (x86).  The ant build
script's test target will build and run the test suite, which has decent
coverage and is a quick way to determine if your environment is set up
correctly.<p> 
If you want to do a build yourself, you'll need <a
href="http://ant.apache.org">ANT</a>, <a
href="http://directory.fsf.org/make.html">GNU make</a> and <a
href="http://gcc.gnu.org">GCC</a>.  On windows, you will need either <a
href="http://www.cygwin.com">cygwin GCC</a> or the MINGW32 version (MSVC will
build most of the JNA native library, but will not build the <code>libffi</code>
library and chokes on the libffi includes).  To rebuild <code>jna.jar</code>, and run the unit tests, do<br>  
<blockquote><code><pre>
% ant dist test
</pre></code></blockquote>
<p>
The project also includes <a href="http://netbeans.org">NetBeans</a> and <a href="http://www.eclipse.org">Eclipse</a> project configurations, if you're so inclined.<p>

<h3>History</h3>
<p>Fragments of this project date back to a small shared stubs library originally written by Sheng Liang of the Sun JNI team and demoed at JavaOne circa 1999. <p>
Todd Fast (also of Sun) first published JNA on dev.java.net in the fall of 2006 (that code is still available in the SVN repo under the <a href="https://jna.dev.java.net/svn/jna/tags/CVS%20HEAD">CVS HEAD</a> tag).  From the original project announcement:
<blockquote><pre>
Headline        Initial JNA code checked in
Date            Nov 30, 2006
Contributed by 	toddfast
</pre>
Announcement<p>

Thanks everyone for your interest in the Java Native Access (JNA) project! I've just checked in the initial code. I've worked on this little project off-and-on for the better part of 6-7 years, and this release comes about a year after I last looked at it. Therefore, I'm only just now getting familiar with it again after refactoring and redesigning for JDK 5 last year, so there may be any number of issues or shortcomings leftover since my last time with it. Please look through the code and get involved!<p>

The Java library code is contained in a NetBeans 5.x project. If you want to build it, please use NetBeans or use the Ant build script in the root of the jnalib/ directory. I will upload a binary at some point to make it a bit easier to get started.<p>

I've checked in binaries of the jnidispatch library and the testlib library for Win32 (.dll's), but don't have convenient access to build these for other platforms. I would greatly appreciate help from others to compile and test versions for other platforms, particularly Mac OS.<p>

To get an idea how to use JNA, please refer to the JUnit tests in the test/ directory. These are crufty and not meant to be examples, but will have to suffice until real samples are available (I would definitely appreciate community help with those as well). Note that you will need to modify your java.library.path system property to include the jnidispatch binary (and possibly the testlib binary) in order to use JNA or run the unit tests. For example:
java -Djava.library.path=./native/testlib/Debug;./native/jnidispatch/Debug ... 
</blockquote>

<p>Timothy Wall rebooted the project in February of 2007, introducing a number of critical features, adding linux and OSX ports, and making the library usable to a much wider audience.  I was looking for a way to experiment with native libraries without having to carve out a new Makefile and build process (those of you who've never built multi-lingual projects involving C don't know what you're missing).  Specifically I wanted some shaped windows and better file system access.  After a few proof-of-concept tests, I scouted around for existing projects from which I could bootstrap (see the <a href="https://jna.dev.java.net/svn/jna/trunk/jnalib/OTHERS">OTHERS</a> file for some of the projects that are out there).  JNA had the simplest, most straightforward architecture (as did <a href="http://nlink.dev.java.net">NLINK</a>, which likely had the same roots).  It was also the least problematic to make work cross-platform with a consistent build process.<p>

Wayne Meissner has contributed enormously ("a metric buttload of hard work") in getting libffi and the various additional native libraries working.  His work on a Java interface to the gstreamer library has contributed a number of critical features to JNA.<p>

<script src="https://ssl.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-1166339-4";
urchinTracker();
</script>
<div name="meta-info" style="visibility:hidden;">
java,jna,jni,c/c++,native,method,function,call,ctypes,ffi,foreign function interface,jdirect,jinvoke,pinvoke,platform invoke,native library access,native access,call native from java,java c library,easy jni,call c code from java,avoid jni>
</div>
</body>
</html>
<!-- 
Local variables:
eval: (add-hook 'write-file-hooks 'time-stamp)
time-stamp-start: "<meta name=\"date\" content=\""
time-stamp-format: "%:y-%02m-%02d"
time-stamp-end: "\">"
End:
-->

